(function(){var a=YAHOO.util.Dom,t=YAHOO.util.Selector;var r=Alfresco.util.encodeHTML,d=Alfresco.util.userProfileLink,c=Alfresco.Share.userAvatar;Alfresco.CommentsList=function q(y){Alfresco.CommentsList.superclass.constructor.call(this,"Alfresco.CommentsList",y,["datasource","datatable","paginator","history","animation"]);YAHOO.Bubbling.on("editorInitialized",this.onEditorInitialized,this);YAHOO.Bubbling.on("commentNode",this.onCommentNode,this);YAHOO.Bubbling.on("versionReverted",function(){this.widgets.alfrescoDataTable.reloadDataTable()},this);YAHOO.Bubbling.on("metadataRefresh",function(){this.widgets.alfrescoDataTable.reloadDataTable()},this);this.busy=false;this.hashChecked=false;return this};YAHOO.extend(Alfresco.CommentsList,Alfresco.component.Base,{options:{nodeRef:null,siteId:null,activity:null,editorConfig:{}},busy:null,hashChecked:null,onReady:function n(){var y=document.createElement("div");a.addClass(y,"comments-list");a.addClass(y,"hidden");a.get(this.id+"-body").appendChild(y);this.widgets.editFormWrapper=y;YAHOO.util.Event.addListener(window,"resize",function(){if(this.currentEditedRowId){this.synchronizeElements(this.widgets.editFormWrapper,this.currentEditedRowId+"-form-container")}this.resizeCommentDetails()},this,true);this.setupCommentList();this.setupAddCommentForm()},resizeCommentDetails:function h(){var B=a.get(this.id+"-body").offsetWidth,C=YAHOO.util.Selector.query("div.comment-details",this.id+"-body");if(C.length!=0){var z=window.getComputedStyle(C[0],null).getPropertyValue("padding-left").replace("px",""),y=window.getComputedStyle(C[0],null).getPropertyValue("padding-right").replace("px","");B=B-z-y}for(var A=0;A<C.length;A++){C[A].style.width=B+"px"}},setupCommentList:function x(){var y=Alfresco.constants.URL_SERVICECONTEXT+"components/node/"+this.options.nodeRef.replace(":/","")+"/comments?reverse=true";this.widgets.alfrescoDataTable=new Alfresco.util.DataTable({dataSource:{url:y,pagingResolver:function(z,A){return"startIndex="+z+"&pageSize="+A},config:{responseSchema:{resultsList:"items",metaFields:{paginationRecordOffset:"startIndex",paginationRowsPerPage:"pageSize",totalRecords:"total"}}},doBeforeParseData:this.bind(this.handlePermissions)},dataTable:{container:this.id+"-comments-list",columnDefinitions:[{key:"comment",sortable:false,formatter:this.bind(this.renderCellComment)}],config:{MSG_EMPTY:this.msg("message.noComments")}},paginator:{history:false,config:{containers:[this.id+"-paginator-top",this.id+"-paginator-bottom"],rowsPerPage:this.options.maxItems}}});this.widgets.alfrescoDataTable.getDataTable().subscribe("beforeRenderEvent",function(){a.removeClass(t.query("hr.hidden"),"hidden")},this,this);this.widgets.alfrescoDataTable.getDataTable().subscribe("renderEvent",function(){this.resizeCommentDetails()},this,this)},handlePermissions:function e(A,y){var z=y.nodePermissions||{};if(z.create){a.removeClass(this.id+"-actions","hidden")}else{a.addClass(this.id+"-actions","hidden")}return y},setupAddCommentForm:function l(){a.get(this.id+"-add-form-container").innerHTML=this.formMarkup(this.id+"-add",Alfresco.constants.USERNAME,null);this.widgets.addCommentEditor=this.setupCommentForm(this.id+"-add",this.options.nodeRef,false).editor},setupCommentForm:function f(C,G,y){var H=C+"-form",F=a.get(C+"-form-container"),A;if(y){A="api/comment/node/"+G.replace(":/","")}else{A="api/node/"+G.replace(":/","")+"/comments"}a.get(H).setAttribute("action",Alfresco.constants.PROXY_URI+A);var D=new YAHOO.widget.Button(C+"-submit",{type:"submit"});D.set("label",this.msg(y?"button.save":"button.addComment"));var B=new YAHOO.widget.Button(C+"-cancel");B.subscribe("click",function(){if(this.widgets.commentForm!=null){this.widgets.commentForm.hideErrorContainer()}this.restoreEditForm()},this,true);B.set("label",this.msg("button.cancel"));var E=new Alfresco.util.RichEditor(Alfresco.constants.HTML_EDITOR,C+"-content",this.options.editorConfig);E.addPageUnloadBehaviour(this.msg("message.unsavedChanges.comment"));E.render();var J=(Alfresco.constants.HTML_EDITOR==="YAHOO.widget.SimpleEditor")?"editorKeyUp":"onKeyUp";E.subscribe(J,function(K){if(E.getContent().length<20||!this.widgets.commentForm.isValid()){E.save();this.widgets.commentForm.validate()}},this,true);if(this.widgets.commentForm!=null){this.widgets.commentForm.hideErrorContainer()}var z=new Alfresco.forms.Form(H);this.widgets.commentForm=z;z.addValidation(C+"-content",Alfresco.forms.validation.mandatory,null);z.setSubmitElements(D);z.setAjaxSubmitMethod(y?Alfresco.util.Ajax.PUT:Alfresco.util.Ajax.POST);z.setAJAXSubmit(true,{successCallback:{fn:function I(K,L){this.restoreEditForm();a.addClass(F,"hidden");this._releaseBusy();this.widgets.alfrescoDataTable.reloadDataTable();B.set("disabled",false)},scope:this},failureMessage:this.msg("message.savecomment.failure"),failureCallback:{fn:function I(K,L){this._releaseBusy();B.set("disabled",false)},scope:this}});z.setSubmitAsJSON(true);z.doBeforeFormSubmit={fn:function(K){this._setBusy(this.msg("message.wait"));B.set("disabled",true);E.save();E.getEditor().undoManager.clear();E.getEditor().nodeChanged()},scope:this};z.doBeforeAjaxRequest={fn:function(K,L){if(this.options.activity){K.dataObj.itemTitle=this.options.activity.itemTitle;K.dataObj.page=this.options.activity.page;K.dataObj.pageParams=YAHOO.lang.JSON.stringify(this.options.activity.pageParams)}return true},scope:this};z.init();return{form:z,editor:E}},restoreEditForm:function m(){if(this.currentEditedRowId){var B=a.get(this.currentEditedRowId+"-form-container"),y=a.get(this.currentEditedRowId+"-comment-container");if(B&&y){a.removeClass(B.parentNode,"theme-bg-color-4");a.addClass(B,"hidden");a.removeClass(y,"hidden");a.addClass(this.widgets.editFormWrapper,"hidden")}}a.addClass(this.id+"-add-form-container","hidden");a.removeClass(this.widgets.onAddCommentClick.get("element"),"hidden");var A=this.widgets.alfrescoDataTable.widgets.paginator._containers,z=0;for(z=0;z<A.length;++z){a.removeClass(A[z],"hidden")}},renderCellComment:function b(C,A,E,F){var B=A.getData(),y="",D=this.id+"-"+A.getId(),z=B.permissions;y+='<div id="'+D+'-comment-container" class="comment-details">';y+='   <div class="icon">'+c(B.author.username)+"</div>";y+='   <div class="details">';y+='      <span class="info">';y+=d(B.author.username,B.author.firstName+" "+B.author.lastName,'class="theme-color-1"')+" ";y+=Alfresco.util.relativeTime(Alfresco.util.fromISO8601(B.modifiedOnISO))+"<br/>";y+="      </span>";y+='      <span class="comment-actions">';if(z.edit){y+='       <a href="#" name=".onEditCommentClick" rel="'+A.getId()+'" title="'+this.msg("link.editComment")+'" class="'+this.id+' edit-comment">&nbsp;</a>'}if(z["delete"]){y+='       <a href="#" name=".onConfirmDeleteCommentClick" rel="'+A.getId()+'" title="'+this.msg("link.deleteComment")+'" class="'+this.id+' delete-comment">&nbsp;</a>'}y+="      </span>";y+='      <div class="comment-content">'+(B.content||"")+"</div>";y+="   </div>";y+='   <div class="clear"></div>';y+="</div>";y+='<div id="'+D+'-form-container" class="comment-form hidden">';y+="   &nbsp;<!-- EMPTY SPACE FOR FLOATING COMMENT FORM -->";y+="</div>";C.innerHTML=y},formMarkup:function o(A,z,B){var y="";y+='<div id="'+A+'-actual-form-container" class="comment-form">';y+='   <h2 class="thin dark">'+this.msg(B?"header.edit":"header.add")+"</h2>";y+=c(z);y+='   <form id="'+A+'-form" method="POST" action="">';if(this.options.siteId){y+='      <input type="hidden" name="site" value="'+this.options.siteId+'" />'}y+='      <textarea name="content" id="'+A+'-content" style="width: 100%">'+(B||"")+"</textarea>";y+='      <div class="buttons">';y+='         <input type="submit" id="'+A+'-submit" value=""/>';y+='         <input type="reset"  id="'+A+'-cancel" value="" />';y+="      </div>";y+="   </form>";y+='   <div class="clear"></div>';y+="</div>";return y},onEditorInitialized:function j(){if(!this.hashChecked&&window.location.hash=="#comment"){this.hashChecked=true;this.onAddCommentClick(true);a.get(this.id+"-add-comment").scrollIntoView()}},onCommentNode:function v(z,y){if(this.options.nodeRef==y[1]){this.onAddCommentClick();a.get(this.id+"-add-comment").scrollIntoView()}},onAddCommentClick:function p(z){this.restoreEditForm();if(z==null){this.setupAddCommentForm()}a.addClass(this.widgets.onAddCommentClick.get("element"),"hidden");this.widgets.addCommentEditor.setContent("");this.widgets.addCommentEditor.save();a.removeClass(this.id+"-add-form-container","hidden");this.widgets.addCommentEditor.focus();if(document.activeElement.nodeName!="IFRAME"){var y=this.widgets.addCommentEditor;window.setTimeout(function(){y.focus()},500)}},onEditCommentClick:function s(A){this.restoreEditForm();var E=this.widgets.alfrescoDataTable.getData(A),C=this.id+"-"+A,B=a.get(C+"-form-container"),D=a.get(C+"-comment-container");this.currentEditedRowId=C;a.addClass(B.parentNode,"theme-bg-color-4");a.addClass(D,"hidden");a.removeClass(B,"hidden");this.widgets.editFormWrapper.innerHTML=this.formMarkup(C,E.author.username,E.content);this.widgets.editCommentEditor=this.setupCommentForm(C,E.nodeRef,true).editor;this.synchronizeElements(this.widgets.editFormWrapper,B);a.removeClass(this.widgets.editFormWrapper,"hidden");var z=this.widgets.alfrescoDataTable.widgets.paginator._containers,y=0;for(y=0;y<z.length;++y){a.addClass(z[y],"hidden")}this.widgets.editCommentEditor.focus()},synchronizeElements:function w(B,y){var A=new YAHOO.util.Element(y),z=new YAHOO.util.Element(B),C=YAHOO.util.Dom.getRegion(A.get("id"));z.setStyle("position","absolute");z.setStyle("left",C.left+"px");z.setStyle("top",C.top+"px");z.setStyle("width",C.width+"px");z.setStyle("height",C.height+"px")},onConfirmDeleteCommentClick:function u(A){var C=this.widgets.alfrescoDataTable.getData(A),B=this;Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.confirm.delete.title"),text:this.msg("message.confirm.delete"),buttons:[{text:this.msg("button.delete"),handler:function z(){this.destroy();B.deleteComment.call(B,C)}},{text:this.msg("button.cancel"),handler:function y(){this.destroy()},isDefault:true}]})},deleteComment:function k(E){if(!this._setBusy(this.msg("message.wait"))){return}var D=function B(F,H){this._releaseBusy();if(this.widgets.alfrescoDataTable.lastResultCount==1&&this.widgets.alfrescoDataTable.currentSkipCount>0){var G=this.widgets.alfrescoDataTable;G.currentSkipCount=G.currentSkipCount-G.currentMaxItems}this.widgets.alfrescoDataTable.reloadDataTable()};var A=function y(F,G){this._releaseBusy()};var z=Alfresco.constants.PROXY_URI+"api/comment/node/"+E.nodeRef.replace(":/",""),C=false;if(this.options.siteId){z+=C?"&":"?";z+="site="+encodeURIComponent(this.options.siteId);C=true}if(this.options.activity){z+=C?"&":"?";z+="itemTitle="+encodeURIComponent(this.options.activity.itemTitle)+"&";z+="page="+encodeURIComponent(this.options.activity.page)+"&";z+="pageParams="+encodeURIComponent(YAHOO.lang.JSON.stringify(this.options.activity.pageParams));C=true}Alfresco.util.Ajax.jsonDelete({url:z,successMessage:this.msg("message.delete.success"),successCallback:{fn:D,scope:this},failureMessage:this.msg("message.delete.failure"),failureCallback:{fn:A,scope:this}})},_setBusy:function g(y){if(this.busy){return false}this.busy=true;this.widgets.busyMessage=Alfresco.util.PopupManager.displayMessage({text:y,spanClass:"wait",displayTime:0});return true},_releaseBusy:function i(){if(this.busy){this.widgets.busyMessage.destroy();this.busy=false;return true}else{return false}}})})();