define(["dojo/_base/declare","alfresco/menus/AlfCascadingMenu","alfresco/core/CoreXhr","alfresco/menus/AlfMenuGroup","alfresco/menus/AlfMenuItem","dojo/_base/array","service/constants/Default"],function(h,a,f,l,d,k,c){return h([a,f],{i18nRequirements:[{i18nFile:"./i18n/AlfCreateTemplateContentMenu.properties"}],widgets:[{name:"alfresco/header/AlfMenuItem",config:{iconClass:"alf-loading-icon",label:"loading.label"}}],postCreate:function g(){this.inherited(arguments);if(this.label){this.set("label",this.message(this.label))}else{this.set("label",this.message("menu.label"))}if(this.popup){this.popup.onOpen=dojo.hitch(this,"loadTemplates")}else{this.alfLog("error","No menu popup - something has gone wrong!")}},_templatesUrl:null,_templatesLoaded:false,loadTemplates:function j(){if(this._favouritesLoaded){this.alfLog("log","Templates already loaded")}else{this.alfLog("log","Loading templates");var o=this._templatesUrl;if(o==null){o=c.PROXY_URI+"slingshot/doclib/node-templates"}this.serviceXhr({url:o,method:"GET",successCallback:this._templatesLoaded,failureCallback:this._templatesLoadFailed,callbackScope:this})}},_templatesLoaded:function n(p,o){this.alfLog("log","Templates data loaded successfully",p);this._favouritesLoaded=true;var q=(this.popup&&this.popup.getChildren().length>0&&this.popup.getChildren()[0].focused);var s=this;k.forEach(this.popup.getChildren(),function(u,t){s.popup.removeChild(u)});if(p.data){if(p.data.length>0){var r=new l({});this.popup.addChild(r);k.forEach(p.data,dojo.hitch(this,"_addMenuItem",r))}else{this.addNoTemplatesMessageItem()}}if(q){this.popup.focusFirstChild()}},_templatesLoadFailed:function i(p,o){this.alfLog("error","Could not load templates menu items",p);var q=this;k.forEach(this.popup.getChildren(),function(s,r){q.popup.removeChild(s)});this.addTemplatesFailMessageItem()},addNoTemplatesMessageItem:function b(){this._templatesMessageItem=new d({label:"no.templates.label"});this.popup.addChild(this._templatesMessageItem)},addTemplatesFailMessageItem:function m(){this._templatesMessageItem=new d({label:"templates.load.error"});this.popup.addChild(this._templatesMessageItem)},templatePublishTopic:"ALF_CREATE_CONTENT",templateIconClass:"alf-textdoc-icon",_addMenuItem:function e(s,r,p){var o=(r.title!="")?r.title:r.name;var q=new d({label:o,iconClass:this.templateIconClass,publishTopic:this.templatePublishTopic,publishPayload:{type:"template",params:{nodeRef:r.nodeRef}}});s.addChild(q)}})});