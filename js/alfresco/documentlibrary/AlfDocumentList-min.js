define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/text!./templates/AlfDocumentList.html","alfresco/core/Core","alfresco/core/CoreWidgetProcessing","alfresco/core/CoreXhr","alfresco/core/PathUtils","alfresco/core/JsNode","alfresco/documentlibrary/_AlfDocumentListTopicMixin","alfresco/documentlibrary/_AlfHashMixin","alfresco/core/DynamicWidgetProcessingTopics","alfresco/services/_PreferenceServiceTopicMixin","alfresco/documentlibrary/views/AlfDocumentListView","dojo/_base/array","dojo/_base/lang","alfresco/menus/AlfCheckableMenuItem","dojo/hash","dojo/io-query","dojo/dom-construct","dojo/dom-class"],function(f,e,l,h,w,a,Y,x,k,ab,Z,c,aa,I,i,g,E,V,m,U,z){return f([e,l,w,a,Y,x,ab,Z,c,aa],{nonAmdDependencies:["/js/yui-common.js","/js/alfresco.js"],i18nRequirements:[{i18nFile:"./i18n/AlfDocumentList.properties"}],cssRequirements:[{cssFile:"./css/AlfDocumentList.css"}],templateString:h,viewMap:null,viewControlsMap:null,widgets:null,usePagination:true,useInfiniteScroll:false,showFolders:true,useHash:false,hashVarsForUpdate:[],requestInProgress:false,blockConcurrentRequests:false,postMixInProperties:function v(){this.alfPublish(this.getPreferenceTopic,{preference:"org.alfresco.share.documentList.documentsPerPage",callback:this.setPageSize,callbackScope:this});this.currentFilter={path:"/"};this.alfSubscribe(this.viewSelectionTopic,g.hitch(this,"onViewSelected"));this.alfSubscribe(this.documentSelectionTopic,g.hitch(this,"onDocumentSelection"));this.alfSubscribe(this.sortRequestTopic,g.hitch(this,"onSortRequest"));this.alfSubscribe(this.sortFieldSelectionTopic,g.hitch(this,"onSortFieldSelection"));this.alfSubscribe(this.showFoldersTopic,g.hitch(this,"onShowFolders"));this.alfSubscribe(this.pageSelectionTopic,g.hitch(this,"onPageChange"));this.alfSubscribe(this.docsPerpageSelectionTopic,g.hitch(this,"onDocsPerPageChange"));this.alfSubscribe(this.reloadDataTopic,g.hitch(this,"loadData"));if(this.useInfiniteScroll){this.alfSubscribe(this.scrollNearBottom,g.hitch(this,"onScrollNearBottom"))}this.alfSubscribe("ALF_RETRIEVE_DOCUMENTS_REQUEST_SUCCESS",g.hitch(this,"onDataLoadSuccess"));this.alfSubscribe("ALF_RETRIEVE_DOCUMENTS_REQUEST_FAILURE",g.hitch(this,"onDataLoadFailure"));this.alfSubscribe(this.requestInProgressTopic,g.hitch(this,"onRequestInProgress"));this.alfSubscribe(this.requestFinishedTopic,g.hitch(this,"onRequestFinished"));this.setDisplayMessages()},setDisplayMessages:function S(){this.noViewSelectedMessage=this.message("doclist.no.view.message");this.noDataMessage=this.message("doclist.no.data.message");this.fetchingDataMessage=this.message("doclist.loading.data.message");this.renderingViewMessage=this.message("doclist.rendering.data.message");this.fetchingMoreDataMessage=this.message("doclist.loading.data.message");this.dataFailureMessage=this.message("doclist.data.failure.message")},setPageSize:function K(ac){if(ac==null){ac=25}this.currentPageSize=ac},linkClickTopic:"ALF_DOCLIST_NAV",onItemLinkClick:function r(ad){var ac=g.getObject("item.node",false,ad);if(ac.isContainer==true||ac.isLink==true){this.onFolderClick(ad)}else{this.onDocumentClick(ad)}},onFolderClick:function O(ac){if(ac.url!=null){this.currentFilter=this.processFilter(ac.url);if(this._readyToLoad){this.loadData()}}else{this.alfLog("warn","A 'url' attribute was expected to be provided for an item click",ac,this)}},onDocumentClick:function n(ac){},postCreate:function t(){this.viewMap={};this.viewControlsMap={};if(this.widgets){this.processWidgets(g.clone(this.widgets))}},waitForPageWidgets:true,_readyToLoad:false,onPageWidgetsReady:function P(ad){this.alfUnsubscribe(this.pageWidgetsReadySubcription);this._readyToLoad=true;if(this.useHash){this.alfSubscribe(this.filterChangeTopic,g.hitch(this,"onChangeFilter"));var ac=m.queryToObject(V());if(!this._payloadContainsUpdateableVar(ac)){this.alfPublish("ALF_NAVIGATE_TO_PAGE",{url:m.objectToQuery(this.currentFilter),type:"HASH"},true)}else{this.initialiseFilter()}}else{this.alfSubscribe(this.linkClickTopic,g.hitch(this,"onItemLinkClick"));if(this._readyToLoad){this.loadData()}}},allWidgetsProcessed:function y(ac){i.forEach(ac,g.hitch(this,"registerView"));if(this._currentlySelectedView==null){for(view in this.viewMap){this._currentlySelectedView=view;break}}this.alfPublish(this.viewSelectionTopic,{value:this._currentlySelectedView});if(this.waitForPageWidgets==true){this.pageWidgetsReadySubcription=this.alfSubscribe("ALF_WIDGETS_READY",g.hitch(this,"onPageWidgetsReady"),true)}else{this._readyToLoad=true;this.onPageWidgetsReady()}},registerView:function R(ac,ad){if(ac.isInstanceOf(I)){this.alfLog("log","Registering DocumentList view",ac);var af=ac.getViewSelectionConfig();if(af==null||!this.isValidViewSelectionConfig(af)){this.alfLog("error","The following DocumentList view does not provide a valid selection menu item upon request",af)}else{var ag=ac.getViewName();if(ag==null){ag=ad}af.value=ag;if(ag==this.view){this._currentlySelectedView=ag;af.checked=true}this.publishAdditionalControls(ag,ac);af.publishTopic=this.viewSelectionTopic;af.group=this.viewSelectionMenuItemGroup;var ae=new E(af);this.alfPublish(this.selectionMenuItemTopic,{menuItem:ae});this.viewMap[ag]=ac}}else{this.alfLog("warn","The following widget was provided as a view, but it does not inherit from 'alfresco/documentlibrary/AlfDocumentListView'",ac)}},isValidViewSelectionConfig:function T(ac){return(ac.label!=null&&ac.label!="")},_currentlySelectedView:null,_currentData:null,onViewSelected:function D(ac){if(this._currentData==null){this.alfLog("warn","There is no data to render a view with");this.showNoDataMessage()}else{if(ac==null||ac.value==null){this.alfLog("warn","A request was made to select a view, but not enough information was provided",ac)}else{if(this._currentlySelectedView==ac.value){}else{if(this.viewMap[ac.value]==null){this.alfLog("error","A request was made to select a non-existent view. Requested view: ",ac.value," from: ",this.viewMap)}else{if(typeof this.viewMap[ac.value].renderView==="function"){this._currentlySelectedView=ac.value;var ad=this.viewMap[ac.value];this.showRenderingMessage();ad.setData(this._currentData);ad.renderView(this.useInfiniteScroll);this.showView(ad)}else{this.alfLog("error","A view was requested that does not define a 'renderView' function",this.viewMap[ac.value])}}}}}},publishAdditionalControls:function u(ae,ac){var ad=this.viewControlsMap[ae];if(ad==null){ad=ac.getAdditionalControls();this.viewControlsMap[ae]=ad}if(ad!=null){this.alfPublish(this.dynamicallyAddWidgetTopic,{targetId:"DOCLIB_TOOLBAR",targetPosition:0,widgets:ad})}},hideChildren:function F(ac){i.forEach(ac.children,function(ad){z.add(ad,"share-hidden")})},showNoDataMessage:function C(){this.hideChildren(this.domNode);z.remove(this.noDataNode,"share-hidden")},showDataLoadFailure:function H(){this.hideChildren(this.domNode);z.remove(this.dataFailureNode,"share-hidden")},showLoadingMessage:function s(){if(!this.useInfiniteScroll){this.hideChildren(this.domNode);z.remove(this.dataLoadingNode,"share-hidden")}else{z.remove(this.dataLoadingMoreNode,"share-hidden")}},showRenderingMessage:function j(){if(!this.useInfiniteScroll){this.hideChildren(this.domNode);z.remove(this.renderingViewNode,"share-hidden")}},showView:function q(ac){this.hideChildren(this.domNode);if(this.viewsNode.children.length>0){this.viewsNode.removeChild(this.viewsNode.children[0])}U.place(ac.domNode,this.viewsNode);z.remove(this.viewsNode,"share-hidden");ac.onViewShown()},onChangeDisplayedNode:function Q(ac){},onChangeFilter:function G(ac){if(this._payloadContainsUpdateableVar(ac)){this.currentFilter=ac;if(this._readyToLoad){this.loadData()}}},loadData:function L(){if(!this.requestInProgress){this.showLoadingMessage();var ac={path:this.currentPath,type:this.showFolders?"all":"documents",site:this.siteId,container:this.containerId,sortAscending:this.sortAscending,sortField:this.sortField,filter:this.currentFilter,libraryRoot:this.rootNode};if(this.usePagination){ac.page=this.currentPage;ac.pageSize=this.currentPageSize}if(this.useInfiniteScroll){ac.page=this.currentPage;ac.pageSize=this.currentPageSize}else{this.alfPublish(this.clearDocDataTopic)}if((this.siteId==null||this.siteId=="")&&this.nodeRef!=null){ac.nodeRef=this.nodeRef.toString()}ac.alfResponseTopic=this.pubSubScope+"ALF_RETRIEVE_DOCUMENTS_REQUEST";this.alfPublish("ALF_RETRIEVE_DOCUMENTS_REQUEST",ac,true)}else{}},onDataLoadSuccess:function W(af){this.alfLog("log","Data Loaded",af,this);for(var ad=0;ad<af.response.items.length;ad++){af.response.items[ad].jsNode=new k(af.response.items[ad].node)}this._currentData=af.response;this.alfPublish(this.documentsLoadedTopic,{documents:this._currentData.items,totalDocuments:this._currentData.totalRecords,startIndex:this._currentData.startIndex});if(this._currentData.metadata){this.alfPublish(this.metadataChangeTopic,{node:this._currentData.metadata})}var ae=null;if(this._currentData.metadata&&this._currentData.metadata.parent&&this._currentData.metadata.parent.permissions&&this._currentData.metadata.parent.permissions.user){this.alfPublish(this.userAccessChangeTopic,{userAccess:this._currentData.metadata.parent.permissions.user})}var ac=this.viewMap[this._currentlySelectedView];if(ac!=null){this.showRenderingMessage();ac.setData(this._currentData);ac.renderView(this.useInfiniteScroll);this.showView(ac);this.alfPublish("ALF_RESIZE_SIDEBAR",{})}this.alfPublish(this.requestFinishedTopic,{})},onDataLoadFailure:function W(ad,ac){this.alfLog("error","Data Load Failed",ad,ac);this._currentData=null;this.showDataLoadFailure();this.alfPublish(this.requestFinishedTopic,{})},currentFilter:null,currentPage:1,currentPageSize:25,sortAscending:true,sortField:"cm:name",onDocumentSelection:function B(ac){this.alfLog("log","Documents Selected: ",ac)},onSortRequest:function M(ad){this.alfLog("log","Sort requested: ",ad);if(ad&&(ad.direction!=null||ad.value!=null)){if(ad.direction){this.sortAscending=(ad.direction=="ascending")}if(ad.value){this.sortField=ad.value}if(this._readyToLoad==true){if(this.useHash==true){var ac=m.queryToObject(V());if(this.sortField!=null){ac.sortField=this.sortField}if(this.sortAscending!=null){ac.sortAscending=this.sortAscending}this.alfPublish("ALF_NAVIGATE_TO_PAGE",{url:m.objectToQuery(ac),type:"HASH"},true)}else{this.loadData()}}}},onSortFieldSelection:function N(ad){this.alfLog("log","Sort field selected: ",ad);if(ad&&ad.value!=null){this.sortField=ad.value;if(ad.direction){this.sortAscending=(ad.direction=="ascending")}if(this._readyToLoad==true){if(this.useHash==true){var ac=m.queryToObject(V());if(this.sortField!=null){ac.sortField=this.sortField}if(this.sortAscending!=null){ac.sortAscending=this.sortAscending}this.alfPublish("ALF_NAVIGATE_TO_PAGE",{url:m.objectToQuery(ac),type:"HASH"},true)}else{this.loadData()}}}},onShowFolders:function b(ac){this.alfLog("log","Show Folders Request: ",ac);if(ac&&ac.selected!=null){this.showFolders=ac.selected;if(this._readyToLoad){this.loadData()}}},onPageChange:function J(ac){if(ac&&ac.value!=null&&ac.value!=this.currentPage){this.currentPage=ac.value;if(this._readyToLoad){this.loadData()}}},onDocsPerPageChange:function A(ac){if(ac&&ac.value!=null&&ac.value!=this.currentPageSize){if(this.currentPage==1){}else{if((this._currentData.totalRecords-ac.value)<((this.currentPage-1)*ac.value)){this.currentPage=Math.ceil(this._currentData.totalRecords/ac.value)}else{}}this.currentPageSize=ac.value;if(this._readyToLoad){this.loadData()}}},onScrollNearBottom:function X(ac){if(this.useInfiniteScroll&&this._currentData.totalRecords<this._currentData.numberFound){this.currentPage++;this.loadData()}else{this.alfPublish(this.eventsScrollReturnTopic)}},onRequestInProgress:function p(){this.requestInProgress=true},onRequestFinished:function o(){this.requestInProgress=false},_payloadContainsUpdateableVar:function d(ad){if(this.hashVarsForUpdate==null||this.hashVarsForUpdate.length==0){return true}for(var ac=0;ac<this.hashVarsForUpdate.length;ac++){if(this.hashVarsForUpdate[ac] in ad){return true}}return false}})});