define(["dojo/_base/declare","alfresco/core/Core","alfresco/core/CoreXhr","alfresco/core/NotificationUtils","alfresco/core/ObjectTypeUtils","dojo/request/xhr","dojo/json","dojo/_base/lang","dojo/dom-construct","alfresco/buttons/AlfButton","service/constants/Default","alfresco/dialogs/AlfDialog"],function(e,s,y,A,l,N,i,f,K,m,x,I){return e([s,y,A],{i18nRequirements:[{i18nFile:"./i18n/SiteService.properties"}],constructor:function w(Q){f.mixin(this,Q);this.alfSubscribe("ALF_GET_SITES",f.hitch(this,"getSites"));this.alfSubscribe("ALF_GET_SITES_ADMIN",f.hitch(this,"getAdminSites"));this.alfSubscribe("ALF_GET_SITE_MEMBERSHIPS",f.hitch(this,"getSiteMemberships"));this.alfSubscribe("ALF_GET_SITE_DETAILS",f.hitch(this,"getSiteDetails"));this.alfSubscribe("ALF_UPDATE_SITE_DETAILS",f.hitch(this,"updateSite"));this.alfSubscribe("ALF_BECOME_SITE_MANAGER",f.hitch(this,"becomeSiteManager"));this.alfSubscribe("ALF_JOIN_SITE",f.hitch(this,"joinSite"));this.alfSubscribe("ALF_REQUEST_SITE_MEMBERSHIP",f.hitch(this,"requestSiteMembership"));this.alfSubscribe("ALF_LEAVE_SITE",f.hitch(this,"leaveSiteRequest"));this.alfSubscribe("ALF_LEAVE_SITE_CONFIRMATION",f.hitch(this,"leaveSite"));this.alfSubscribe("ALF_CREATE_SITE",f.hitch(this,"createSite"));this.alfSubscribe("ALF_EDIT_SITE",f.hitch(this,"editSite"));this.alfSubscribe("ALF_DELETE_SITE",f.hitch(this,"onActionDeleteSite"));this.alfSubscribe("ALF_ADD_FAVOURITE_SITE",f.hitch(this,"addSiteAsFavourite"));this.alfSubscribe("ALF_REMOVE_FAVOURITE_SITE",f.hitch(this,"removeSiteFromFavourites"));this.alfSubscribe("ALF_GET_RECENT_SITES",f.hitch(this,"getRecentSites"));this.alfSubscribe("ALF_GET_FAVOURITE_SITES",f.hitch(this,"getFavouriteSites"));var R=this;require([x.URL_RESCONTEXT+"modules/edit-site.js"],function(){R.alfLog("log","Edit Site JavaScript resource loaded")})},getSites:function O(Q){this.serviceXhr({url:x.PROXY_URI+"api/sites",method:"GET",alfTopic:Q.responseTopic})},getAdminSites:function v(R){var Q=(R.page-1)*R.pageSize;this.serviceXhr({url:x.PROXY_URI+"api/admin-sites?skipCount="+Q+"&maxItems="+R.pageSize,method:"GET",alfTopic:R.responseTopic})},getSitesSuccess:function g(S,R){if(S!=null&&l.isArray(S)){var T=(R.responseTopic!=null)?R.responseTopic:"ALF_SITES_LOADED";var Q={items:S};this.alfPublish(T,Q)}else{this.alfLog("error","The request to retrieve available sites returned a response that could not be interpreted",S,R,this)}},getSiteDetails:function P(R){if(R&&R.site&&R.responseTopic){var Q=x.PROXY_URI+"api/sites/"+R.site;this.serviceXhr({url:Q,method:"GET",site:R.site,responseTopic:R.responseTopic,successCallback:this.publishSiteDetails,callbackScope:this})}else{this.alfLog("error","A request to get the details of a site was made, but either the 'site' or 'responseTopic' attributes was not provided",R)}},publishSiteDetails:function F(R,Q){if(Q&&Q.responseTopic){this.alfLog("log","Publishing site details",Q);this.alfPublish(Q.responseTopic,R)}else{this.alfLog("error","It was not possible to publish requested site details because the 'responseTopic' attribute was not set on the original request",R,Q)}},updateSite:function B(S){var Q=f.getObject("shortName",false,S);if(Q!=null){var R=x.PROXY_URI+"api/sites/"+Q;this.serviceXhr({url:R,method:"PUT",data:S,alfTopic:S.responseTopic})}else{this.alfLog("warn","A request was made to update a site but no 'shortName' attribute was provided",S,this)}},onActionDeleteSite:function o(U){var R=U.document;var Q=f.getObject("shortName",false,R);if(Q!=null){var S=this.generateUuid();this._actionDeleteHandle=this.alfSubscribe(S,f.hitch(this,"onActionDeleteSiteConfirmation"),false);var T=new I({generatePubSubScope:false,title:this.message("message.delete-site-confirm-title"),textContent:this.message("message.delete-site-prompt",{"0":Q}),widgetsButtons:[{name:"alfresco/buttons/AlfButton",config:{label:this.message("button.delete-site.confirm-label"),publishTopic:this.pubSubScope+S,publishPayload:U}},{name:"alfresco/buttons/AlfButton",config:{label:this.message("button.delete-site.cancel-label"),publishTopic:"close"}}]});T.show()}else{this.alfLog("warn","A request was made to delete a site but no 'shortName' attribute was provided",R,this)}},onActionDeleteSiteConfirmation:function t(V){if(this._actionDeleteHandle!=null){this.alfUnsubscribe(this._actionDeleteHandle)}else{this.alfLog("warn","A subscription handle was not found for confirming delete actions - this could be a potential memory leak",this)}var T=this.generateUuid();var U=this.alfSubscribe(T+"_SUCCESS",f.hitch(this,"onActionDeleteSiteSuccess"),false);var R=V.document;var Q=f.getObject("shortName",false,R);if(Q!=null){var S=x.PROXY_URI+"api/sites/"+Q;this.serviceXhr({alfTopic:T,subscriptionHandle:U,url:S,method:"DELETE"})}else{this.alfLog("warn","A request was made to delete a site but no 'shortName' attribute was provided",R,this)}},onActionDeleteSiteSuccess:function b(R){var Q=f.getObject("requestConfig.subscriptionHandle",false,R);if(Q!=null){this.alfUnsubscribe(Q)}this.reloadData()},addSiteAsFavourite:function n(S){if(S.site&&S.user){var R=x.PROXY_URI+"api/people/"+encodeURIComponent(S.user)+"/preferences",Q={org:{alfresco:{share:{sites:{favourites:{}}}}}};Q.org.alfresco.share.sites.favourites[S.site]=true;this.serviceXhr({url:R,site:S.site,user:S.user,data:Q,method:"POST",successCallback:this.favouriteSiteAdded,callbackScope:this})}else{this.alfLog("error","A request to make a site a favourite but either the site or user was not specified",S)}},favouriteSiteAdded:function r(R,Q){this.alfLog("log","Favourite Site Added Successfully",R,Q);this.alfPublish("ALF_FAVOURITE_SITE_ADDED",{site:Q.site,user:Q.user})},removeSiteFromFavourites:function a(R){if(R.site&&R.user){var Q=x.PROXY_URI+"api/people/"+encodeURIComponent(R.user)+"/preferences?pf=org.alfresco.share.sites.favourites."+R.site;this.serviceXhr({url:Q,site:R.site,user:R.user,method:"DELETE",successCallback:this.favouriteSiteRemoved,callbackScope:this})}else{this.alfLog("error","A request to remove a site from the favourites list but either the site or user was not specified",R)}},favouriteSiteRemoved:function J(R,Q){this.alfLog("log","Favourite Site Removed Successfully",R,Q);this.alfPublish("ALF_FAVOURITE_SITE_REMOVED",{site:Q.site,user:Q.user})},getSiteMemberships:function j(R){if(R&&R.site&&R.responseTopic){var Q=x.PROXY_URI+"api/sites/"+R.site+"/memberships";this.serviceXhr({url:Q,method:"GET",alfTopic:R.responseTopic})}else{this.alfLog("error","A request to get the details of a site was made, but either the 'site' or 'responseTopic' attributes was not provided",R)}},becomeSiteManager:function c(R){if(R.site){this.alfLog("log","A request has been made for a user to become the manager of a site: ",R);var Q=x.PROXY_URI+"api/sites/"+encodeURIComponent(R.site)+"/memberships";var S={role:(R.role)?R.role:"SiteManager",person:{userName:(R.user)?R.user:x.USERNAME}};this.serviceXhr({url:Q,data:S,method:"POST",successCallback:this.reloadData,callbackScope:this})}else{this.alfLog("error","A request was made for a user to become the manager of a site, but no site was specified",R)}},requestSiteMembership:function D(R){if(R.site&&R.user){this.alfLog("log","A request has been made for a user to join a site: ",R);var Q=x.PROXY_URI+"api/sites/"+encodeURIComponent(R.site)+"/invitations";var S={invitationType:"MODERATED",inviteeRoleName:(R.role)?R.role:"SiteConsumer",inviteeUserName:R.user,inviteeComments:(R.comments)?R.comments:""};this.serviceXhr({url:Q,method:"POST",site:R.site,user:R.user,data:S,successCallback:this.siteMembershipRequestComplete,callbackScope:this})}else{if(!R.site){this.alfLog("error","A request was made to join a site but no site was specified",R)}if(!R.user){this.alfLog("error","A request was made to join a site but no user was specified",R)}}},siteMembershipRequestComplete:function L(R,Q){this.alfLog("log","User has successfully requested to join a moderated site",R,Q);this.displayPrompt({title:"",textContent:this.message("message.request-join-success",{"0":Q.user,"1":Q.site}),widgetsButtons:[{name:"alfresco/buttons/AlfButton",config:{label:this.message("label.ok"),publishTopic:"ALF_NAVIGATE_TO_PAGE",publishPayload:{url:"user/"+Q.user+"/dashboard",type:"SHARE_PAGE_RELATIVE",target:"CURRENT"}}}]})},joinSite:function G(R){if(R.site&&R.user){this.alfLog("log","A request has been made for a user to join a site: ",R);var Q=x.PROXY_URI+"api/sites/"+encodeURIComponent(R.site)+"/memberships";var S={role:(R.role)?R.role:"SiteConsumer",person:{userName:R.user}};this.serviceXhr({url:Q,method:"PUT",site:R.site,user:R.user,data:S,successCallback:this.siteJoined,callbackScope:this})}else{if(!R.site){this.alfLog("error","A request was made to join a site but no site was specified",R)}if(!R.user){this.alfLog("error","A request was made to join a site but no user was specified",R)}}},siteJoined:function u(R,Q){this.alfLog("log","User has successfully joined a site",R,Q);this.alfPublish("ALF_SITE_JOINED",{site:Q.site,user:Q.user});this.reloadPage()},createSite:function C(Q){this.alfLog("log","A request has been made to create a site: ",Q);if(Alfresco&&Alfresco.module&&typeof Alfresco.module.getCreateSiteInstance==="function"){Alfresco.module.getCreateSiteInstance().show()}else{this.alfLog("error","Could not find the 'Alfresco.module.getCreateSiteInstance' function - has 'create-site.js' been included in the page?")}},editSite:function C(Q){this.alfLog("log","A request has been made to edit a site: ",Q);if(Alfresco&&Alfresco.module&&typeof Alfresco.module.getEditSiteInstance==="function"){Alfresco.module.getEditSiteInstance().show({shortName:Q.site})}else{this.alfLog("error","Could not find the 'Alfresco.module.getEditSiteInstance' function - has 'edit-site.js' been included in the page?")}},leaveSiteRequest:function d(Q){this.displayPrompt({title:this.message("message.leave",{"0":Q.siteTitle}),textContent:this.message("message.leave-site-prompt",{"0":Q.siteTitle}),widgetsButtons:[{name:"alfresco/buttons/AlfButton",config:{label:this.message("button.leave-site.confirm-label"),publishTopic:"ALF_LEAVE_SITE_CONFIRMATION",publishPayload:Q}},{name:"alfresco/buttons/AlfButton",config:{label:this.message("button.leave-site.cancel-label"),publishTopic:"ALF_LEAVE_SITE_CANCELLATION",publishPayload:Q}}]})},leaveSite:function q(R){if(R.site&&R.user){this.alfLog("log","A request has been made for a user to leave a site: ",R);var Q=x.PROXY_URI+"api/sites/"+encodeURIComponent(R.site)+"/memberships/"+encodeURIComponent(R.user);this.serviceXhr({url:Q,method:"DELETE",site:R.site,siteTitle:R.siteTitle,user:R.user,userFullName:R.userFullName,successCallback:this.siteLeft,failureCallback:this.siteLeftFailure,callbackScope:this})}else{if(!R.site){this.alfLog("error","A request was made to leave a site but no site was specified",R)}if(!R.user){this.alfLog("error","A request was made to leave a site but no user was specified",R)}}},siteLeft:function z(R,Q){this.alfLog("log","User has successfully left a site",R,Q);this.displayMessage(this.message("message.leaving",{"0":Q.userFullName,"1":Q.siteTitle}));this.alfPublish("ALF_SITE_LEFT",{site:Q.site,user:Q.user});this.leaveSiteSuccess()},siteLeftFailure:function h(R,Q){this.alfLog("log","User has failed to leave a site",R,Q);this.displayMessage(this.message("message.leave-failure",{"0":Q.userFullName,"1":Q.siteTitle}))},reloadPage:function p(R,Q){this.alfPublish("ALF_RELOAD_PAGE",{})},reloadData:function k(R,Q){this.alfPublish("ALF_DOCLIST_RELOAD_DATA",{})},leaveSiteSuccess:function M(R,Q){window.location.href=x.URL_CONTEXT},getRecentSites:function E(T){var S=x.PROXY_URI+"api/people/"+x.USERNAME+"/sites/recent";if(this.currentSite){S=S+"/site/"+this.currentSite}var Q=(T.alfResponseTopic!=null)?T.alfResponseTopic:"ALF_GET_RECENT_SITES";var R={alfTopic:Q,url:S,method:"GET",callbackScope:this};this.serviceXhr(R)},getFavouriteSites:function H(T){var S=x.PROXY_URI+"api/people/"+x.USERNAME+"/sites/favourites";if(this.currentSite){S=S+"/site/"+this.currentSite}var Q=(T.alfResponseTopic!=null)?T.alfResponseTopic:"ALF_GET_FAVOURITE_SITES";var R={alfTopic:Q,url:S,method:"GET",callbackScope:this};this.serviceXhr(R)}})});