define(["dojo/_base/declare","alfresco/core/Core","alfresco/services/_PreferenceServiceTopicMixin","dojo/_base/lang","dojo/sniff","dijit/registry","alfresco/dialogs/AlfDialog","alfresco/buttons/AlfButton","alfresco/testing/SubscriptionLog","alfresco/debug/CoreDataDebugger"],function(s,o,g,t,d,l,k,p,h,n){return s([o,g],{i18nRequirements:[{i18nFile:"./i18n/LoggingService.properties"}],loggingPreferencesId:"org.alfresco.share.logging",logSubscriptionHandle:null,constructor:function q(u){t.mixin(this,u);this.alfSubscribe("ALF_LOGGING_STATUS_CHANGE",t.hitch(this,"onLoggingStatusChange"));this.alfSubscribe("ALF_UPDATE_LOGGING_PREFERENCES",t.hitch(this,"onDetailsDialog"));this.alfSubscribe("ALF_SHOW_PUBSUB_LOG",t.hitch(this,"showPubSubLog"));this.alfSubscribe("ALF_SHOW_DATA_MODEL",t.hitch(this,"showDataModel"));if(this.loggingPreferences!=null){this.handleSubscription()}this.alfPublish(this.getPreferenceTopic,{preference:this.loggingPreferencesId,callback:this.setLoggingStatus,callbackScope:this})},showPubSubLog:function i(u){if(this.pubSubLog==null){this.pubSubLog=new k({title:this.message("logging.pubSubLog.title"),widgetsContent:[{name:"alfresco/testing/SubscriptionLog"}]})}this.pubSubLog.show()},showDataModel:function e(v){var u=new k({pubSubScope:this.pubSubScope,title:this.message("logging.dataModel.title"),widgetsContent:[{name:"alfresco/debug/CoreDataDebugger"}]});u.show()},onLoggingStatusChange:function b(u){if(t.exists("selected",u)&&t.exists("value",u)){this.alfPublish(this.setPreferenceTopic,{preference:this.loggingPreferencesId+"."+u.value,value:(u.selected==true)});this.loggingPreferences[u.value]=(u.selected==true);this.handleSubscription()}},setLoggingStatus:function m(u){if(u==null){u={}}this.loggingPreferences=u;this.handleSubscription()},handleSubscription:function r(){if(this.loggingPreferences.enabled&&this.logSubscriptionHandle==null){this.logSubscriptionHandle=this.alfSubscribe(this.alfLoggingTopic,t.hitch(this,"onLogRequest"))}else{if(!this.loggingPreferences.enabled&&this.logSubscriptionHandle!=null){this.alfUnsubscribe(this.logSubscriptionHandle);this.logSubscriptionHandle=null}}},detailsDialog:null,saveLoggingPrefsUpdateTopic:"ALF_SAVE_LOGGING_PREFERNCES_UPDATE",cancelLoggingPrefsUpdateTopic:"ALF_CANCEL_LOGGING_PREFERNCES_UPDATE",onDetailsDialog:function j(u){if(this.detailsDialog==null){this.alfSubscribe(this.saveLoggingPrefsUpdateTopic,t.hitch(this,"onPrefsUpdateSave"));this.alfSubscribe(this.cancelLoggingPrefsUpdateTopic,t.hitch(this,"onPrefsUpdateCancel"));this.detailsDialog=new k({title:this.message("logging.preferences.title"),widgetsContent:[{name:"alfresco/forms/controls/DojoValidationTextBox",config:{id:this.id+"_LOGGING_FILTER",name:"filter",label:this.message("filter.label"),description:this.message("filter.description"),value:(this.loggingPreferences.filter!=null)?this.loggingPreferences.filter:""}}],widgetsButtons:[{name:"alfresco/buttons/AlfButton",config:{label:this.message("button.save-logging-prefs"),publishTopic:this.saveLoggingPrefsUpdateTopic,publishPayload:u}},{name:"alfresco/buttons/AlfButton",config:{label:this.message("button.cancel-logging-prefs-update"),publishTopic:this.cancelLoggingPrefsUpdateTopic,publishPayload:u}}]})}this.detailsDialog.show()},onPrefsUpdateSave:function a(v){var u=l.byId(this.id+"_LOGGING_FILTER");if(u!=null){var w=u.getValue();this.alfPublish(this.setPreferenceTopic,{preference:this.loggingPreferencesId+".filter",value:w});this.loggingPreferences.filter=w}},onPrefsUpdateCancel:function f(v){var u=l.byId(this.id+"_LOGGING_FILTER");if(u!=null){var w=u.setValue((this.loggingPreferences.filter!=null)?this.loggingPreferences.filter:"")}},loggingPreferences:null,onLogRequest:function c(A){if(A&&A.severity&&A.messageArgs&&(this.loggingPreferences.all==true||this.loggingPreferences[A.severity]==true)){if(typeof console[A.severity]!="function"&&(!d("ie")>9)){console.error("The supplied severity is not a function of console",A.severity)}else{var x=A.callerName;if(x&&x!=""){var z=x.lastIndexOf("__"),v=/([^_])(_){1}/g;if(z!=-1){var w=x.substring(0,z);var y=x.substring(z+2);x=w.replace(v,"$1/")+"["+y+"] >> "}else{x=x+" >> "}}else{x=""}var u=true;if(this.loggingPreferences.filter!=null){var B=new RegExp(this.loggingPreferences.filter);u=B.test(x)}if(u){A.messageArgs[0]=x+A.messageArgs[0];if(d("ie")<=9){if(A.severity=="error"){console.error(A.messageArgs)}else{console.log(A.messageArgs)}}else{console[A.severity].apply(console,A.messageArgs)}}}}}})});