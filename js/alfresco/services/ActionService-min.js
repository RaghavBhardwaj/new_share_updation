define(["dojo/_base/declare","alfresco/core/Core","alfresco/core/CoreXhr","service/constants/Default","alfresco/documentlibrary/_AlfDocumentListTopicMixin","alfresco/services/_NavigationServiceTopicMixin","alfresco/core/UrlUtils","alfresco/core/ArrayUtils","alfresco/core/JsNode","alfresco/core/NotificationUtils","dojo/_base/lang","dojo/_base/array","alfresco/dialogs/AlfDialog","alfresco/pickers/Picker"],function(c,r,S,z,Y,J,t,w,k,D,f,g,M,G){return c([r,S,Y,J,t,D],{i18nRequirements:[{i18nFile:"./i18n/ActionService.properties"}],siteId:null,containerId:null,rootNode:null,constructor:function K(Z){f.mixin(this,Z);this.currentlySelectedDocuments={};this.alfSubscribe(this.documentsLoadedTopic,f.hitch(this,"onDocumentsLoaded"));this.alfSubscribe(this.metadataChangeTopic,f.hitch(this,"handleCurrentNodeChange"));this.alfSubscribe(this.documentSelectedTopic,f.hitch(this,"onDocumentSelected"));this.alfSubscribe(this.documentDeselectedTopic,f.hitch(this,"onDocumentDeselected"));this.alfSubscribe(this.singleDocumentActionTopic,f.hitch(this,"handleSingleDocAction"));this.alfSubscribe(this.syncLocationTopic,f.hitch(this,"onSyncLocation"));this.alfSubscribe(this.unsyncLocationTopic,f.hitch(this,"onUnsyncLocation"));this.alfSubscribe("ALF_MULTIPLE_DOCUMENT_ACTION_REQUEST",f.hitch(this,"handleMultiDocLegacyAction"));this.alfSubscribe("ALF_CREATE_CONTENT",f.hitch(this,"processActionObject"));this.alfSubscribe("ALF_MOVE_DOCUMENTS",f.hitch(this,"onMoveDocuments"));this.alfSubscribe("ALF_ON_ACTION_DETAILS_SUCCESS",f.hitch(this,"onActionDetailsSucess"));this.alfSubscribe("ALF_ON_ACTION_EDIT_INLINE_SUCCESS",f.hitch(this,"onActionEditInlineSucess"))},onFileAction:function X(aa,Z){var ab=Z[1];if(ab){if(!ab.multiple){this.requestRefresh()}}},requestRefresh:function(){this.alfPublish(this.reloadDataTopic,{})},onDocumentsLoaded:function q(Z){this.alfLog("log","New Documents Loaded",Z);this.currentlySelectedDocuments={};this.onSelectedFilesChanged()},_currentNode:null,handleCurrentNodeChange:function x(Z){if(Z&&Z.node){this.alfLog("log","Updating current nodeRef to: ",Z.node);this._currentNode=Z.node}else{this.alfLog("error","A request was made to update the current NodeRef, but no 'node' property was provided in the payload: ",Z)}},handleSingleDocAction:function U(Z){this.alfLog("log","Single document action request:",Z);if(Z&&Z.document!=null&&Z.action!=null){if(typeof Z.action==="string"){if(typeof this[Z.action]==="function"){this[Z.action](Z.document)}else{this.alfLog("warn","No handler implemented to handle this function",this)}}else{if(typeof Z.action==="object"){this.processActionObject(Z.action,Z.document)}}}},handleMultiDocLegacyAction:function H(ab){this.alfLog("log","Multiple document action request:",ab);if(typeof this[ab.action]==="function"){var aa=[];for(var Z in this.currentlySelectedDocuments){aa.push(this.currentlySelectedDocuments[Z])}this[ab.action].call(this,ab,aa)}},_callLegacyActionHandler:function l(aa,ab,Z){this.alfLog("log","Calling handler",aa,ab,Z)},currentlySelectedDocuments:null,selectionTimeout:null,onDocumentSelected:function O(Z){if(Z&&Z.value&&Z.value.nodeRef!=null){this.currentlySelectedDocuments[Z.value.nodeRef]=Z.value;if(this.selectionTimeout!=null){clearTimeout(this.selectionTimeout)}this.selectionTimeout=setTimeout(f.hitch(this,"deferredSelectionHandler"),50)}},deferredSelectionHandler:function F(){this.onSelectedFilesChanged();this.selectionTimeout=null},onDocumentDeselected:function o(Z){if(Z&&Z.value&&Z.value.nodeRef!=null){delete this.currentlySelectedDocuments[Z.value.nodeRef];if(this.selectionTimeout!=null){clearTimeout(this.selectionTimeout)}this.selectionTimeout=setTimeout(f.hitch(this,"deferredSelectionHandler"),50)}},getSelectedDocumentArray:function L(){var Z=[];for(var aa in this.currentlySelectedDocuments){Z.push(this.currentlySelectedDocuments[aa])}return Z},onSelectedFilesChanged:function i(){var Z=this.getSelectedDocumentArray(),ac=[],ad,am,al={},aa,ai,ae=[],aj=[],ag,ak,af,ah;var ab=function ab(an){return(an.node.isContainer?"folder":"document")};for(ag=0,ak=Z.length;ag<ak;ag++){ad=Z[ag];aa=ad.node.permissions.user;for(ai in aa){if(aa.hasOwnProperty(ai)){al[ai]=(al[ai]===undefined?aa[ai]:al[ai]&&aa[ai])}}am=ab(ad);if(!(am in ac)){ac[am]=true;ac.push(am)}if(ag===0){ae=f.clone(ad.node.aspects)}else{for(af=0,ah=ae.length;af<ah;af++){if(!w.arrayContains(ad.node.aspects,ae[af])){w.arrayRemove(ae,ae[af])}}}for(af=0,ah=ad.node.aspects.length;af<ah;af++){if(!w.arrayContains(aj,ad.node.aspects[af])){aj.push(ad.node.aspects[af])}}}this.alfPublish(this.selectedDocumentsChangeTopic,{selectedFiles:Z,userAccess:al,commonAspects:ae,allAspects:aj})},processActionObject:function W(aa,Z){if(aa&&aa.type){if(aa.type=="pagelink"){if(aa.params.page){this.createPageLinkContent(aa,Z)}else{this.alfLog("error","A request was made to perform an action. The 'pagelink' type was requested, but no 'page' attribute was provided: ",aa)}}else{if(aa.type=="link"){if(aa.params.href){this.createLinkContent(aa,Z)}else{this.alfLog("error","A request was made to perform an action. The 'link' type was requested, but no 'href' attribute was provided: ",aa)}}else{if(aa.type=="javascript"){if(aa.params["function"]){this.createJavaScriptContent(aa,Z)}else{this.alfLog("error","A request was made to perform an action. The 'javascript' type was requested, but no 'function' attribute was provided: ",aa)}}else{if(aa.type=="template"){if(aa.params.nodeRef){this.createTemplateContent(aa,Z)}else{this.alfLog("error","A request was made to perform an action. The 'template' type was requested, but no 'nodeRef' attribute was provided: ",aa)}}else{this.alfLog("error","A request was made to perform an action, but an unknown 'type' was provided: ",aa)}}}}}else{this.alfLog("error","A request was made to perform an action, but no 'type' was provided in the payload: ",aa)}},createPageLinkContent:function m(ab,Z){var aa=ab.params.page;if(Z!=null){aa=f.replace(aa,Z)}else{if(this._currentNode!=null){aa=f.replace(aa,{nodeRef:this._currentNode.parent.nodeRef})}}this.alfPublish(this.navigateToPageTopic,{type:this.sharePageRelativePath,url:aa,target:this.currentTarget})},createLinkContent:function B(aa,Z){this.alfPublish(this.navigateToPageTopic,{type:this.fullPath,url:f.replace(aa.params.href,this.getActionUrls(Z,this.siteId,this.repositoryUrl,this.replicationUrlMapping)),target:this.currentTarget})},createJavaScriptContent:function C(ac,Z){if(Z==null){var aa=f.clone(this._currentNode.parent);Z={nodeRef:aa.nodeRef,node:aa,jsNode:new k(aa)}}var ab=this[ac.params["function"]];if(typeof ab==="function"){ab.call(this,ac,[Z])}else{this.callLegacyActionHandler(ac.params["function"],Z)}},callLegacyActionHandler:function u(aa,Z){this.alfLog("warn","Legacy toolbar now removed")},onActionDetails:function N(aa,Z){Z=(f.isArray(Z))?Z[0]:Z;if(Z==null||Z.nodeRef==null){this.alfLog("warn","A request was made to edit the properties of a document but no document or 'nodeRef' attribute was provided",Z,this)}else{this.alfPublish("ALF_RETRIEVE_SINGLE_DOCUMENT_REQUEST",{alfResponseTopic:"ALF_ON_ACTION_DETAILS",nodeRef:Z.nodeRef})}},onActionDetailsSucess:function a(af){if(!f.exists("response.item.node.properties",af)){this.alfLog("warn","When processing a request to display document properties, the expected 'response.item.node.properties' attribute was not found",af,this)}else{var ab=f.getObject("response.item.node.properties",false,af);this.alfLog("log","Display these properties",ab);var ac=[];for(var aa in ab){var ad=aa.split(":"),Z="";if(ad.length==2){Z="prop_"+ad[0]+"_"+ad[1]}var ae={name:"alfresco/forms/controls/DojoValidationTextBox",config:{label:aa,value:ab[aa],name:Z}};ac.push(ae)}this.alfPublish("ALF_CREATE_FORM_DIALOG_REQUEST",{dialogTitle:"Edit Properties",dialogConfirmationButtonTitle:"Save",dialogCancellationButtonTitle:"Cancel",formSubmissionTopic:"ALF_CREATE_CONTENT_REQUEST",widgets:ac})}},onActionUploadNewVersion:function v(aa,Z){this.callLegacyActionHandler("onActionUploadNewVersion",Z)},onActionEditInline:function A(aa,Z){if(Z==null||Z.nodeRef==null){this.alfLog("warn","A request was made to edit the properties of a document but no document or 'nodeRef' attribute was provided",Z,this)}else{this.alfPublish("ALF_RETRIEVE_SINGLE_DOCUMENT_REQUEST",{alfResponseTopic:"ALF_ON_ACTION_EDIT_INLINE",nodeRef:Z.nodeRef,includeContent:true})}},onActionEditInlineSucess:function h(ab){if(!f.exists("response.item.node",ab)){this.alfLog("warn","When processing a request to display document properties, the expected 'response.item.node' attribute was not found",ab,this)}else{var aa=f.getObject("response.item.node",false,ab);var Z=f.getObject("response.itemContent",false,ab);this.alfPublish("ALF_CREATE_FORM_DIALOG_REQUEST",{dialogTitle:"Edit: "+aa.properties["cm:name"],dialogConfirmationButtonTitle:"Save",dialogCancellationButtonTitle:"Cancel",formSubmissionTopic:"ALF_UPDATE_CONTENT_REQUEST",widgets:[{name:"alfresco/forms/controls/DojoValidationTextBox",config:{name:"nodeRef",value:aa.nodeRef,visibilityConfig:{initialValue:false}}},{name:"alfresco/forms/controls/DojoValidationTextBox",config:{name:"prop_mimetype",value:aa.mimetype,visibilityConfig:{initialValue:false}}},{name:"alfresco/forms/controls/DojoValidationTextBox",config:{name:"prop_app_editInline",value:true,visibilityConfig:{initialValue:false}}},{name:"alfresco/forms/controls/DojoValidationTextBox",config:{label:"Name",description:"The name to give the new document",name:"prop_cm_name",value:aa.properties["cm:name"],requirementConfig:{initialValue:true}}},{name:"alfresco/forms/controls/DojoValidationTextBox",config:{label:"Title",description:"The title to give to the new document",name:"prop_cm_title",value:aa.properties["cm:title"]}},{name:"alfresco/forms/controls/DojoTextarea",config:{label:"Description",description:"A description of the folder",name:"prop_cm_description",value:aa.properties["cm:description"]}},{name:"alfresco/forms/controls/AceEditor",config:{mimeType:aa.mimetype,label:"Content",description:"The content for the document",name:"prop_cm_content",value:Z}}]})}},onActionEditOffline:function s(ac,Z){Z=(f.isArray(Z))?Z[0]:Z;if(Z!=null&&Z.node!=null&&Z.node.nodeRef!=null){var ab={nodeRef:Z.node.nodeRef};var aa={url:z.PROXY_URI+"slingshot/doclib/action/checkout/node/"+ab.nodeRef.replace("://","/"),method:"POST",data:ab,successCallback:this.onActionEditOfflineSuccess,failureCallback:this.onActionEditOfflineFailure,callbackScope:this};this.serviceXhr(aa)}else{this.alfLog("error","A request was made to edit a document offline, but the document supplied does not contain enough information",Z)}},onActionEditOfflineSuccess:function y(aa,Z){this.alfLog("log","Edit offline request success",aa,Z);if(aa!=null&&aa.results!=null&&aa.results.length>0&&aa.results[0].downloadUrl!=null){this.displayMessage(this.message("message.edit-offline.success",{"0":aa.results[0].id}));this.alfPublish(this.navigateToPageTopic,{url:z.PROXY_URI+aa.results[0].downloadUrl,type:this.fullPath});this.alfPublish(this.reloadDataTopic,{})}else{this.alfLog("error","A request to edit a document offline returned a successful response but did not provide a 'downloadUrl' attribute",aa,Z)}},onActionEditOfflineFailure:function y(aa,Z){this.alfLog("error","Edit offline request failure",aa,Z);this.displayMessage(this.message("message.edit-offline.failure",{"0":aa.results[0].id}))},onActionCopyTo:function e(ab,Z){var aa=new M({generatePubSubScope:true,title:"Select Location to Copy To",widgetsContent:[{name:"alfresco/pickers/Picker",config:{}}],widgetsButtons:[{name:"alfresco/buttons/AlfButton",config:{label:"OK",publishTopic:"ALF_LOCATION_PICKED"}},{name:"alfresco/buttons/AlfButton",config:{label:"CANCEL",publishTopic:""}}]});aa.show()},onActionMoveTo:function b(aa,Z){this.callLegacyActionHandler("onActionMoveTo",Z)},onActionDelete:function I(ac,ab){var Z=this.generateUuid();this._actionDeleteHandle=this.alfSubscribe(Z,f.hitch(this,"onActionDeleteConfirmation"),true);var aa=new M({generatePubSubScope:false,title:"Confirm Delete",widgetsContent:[{name:"alfresco/documentlibrary/views/AlfDocumentListView",config:{currentData:{items:ab},widgets:[{name:"alfresco/documentlibrary/views/layouts/Row",config:{widgets:[{name:"alfresco/documentlibrary/views/layouts/Cell",config:{widgets:[{name:"alfresco/renderers/SmallThumbnail"}]}},{name:"alfresco/documentlibrary/views/layouts/Cell",config:{widgets:[{name:"alfresco/renderers/Property",config:{propertyToRender:"node.properties.cm:name"}}]}}]}}]}}],widgetsButtons:[{name:"alfresco/buttons/AlfButton",config:{label:"Yes",publishTopic:Z,publishPayload:{nodes:ab,completionTopic:ac.completionTopic}}},{name:"alfresco/buttons/AlfButton",config:{label:"No",publishTopic:"close"}}]});aa.show()},onActionDeleteConfirmation:function E(ab){if(this._actionDeleteHandle!=null){this.alfUnsubscribe(this._actionDeleteHandle)}else{this.alfLog("warn","A subscription handle was not found for confirming delete actions - this could be a potential memory leak",this)}var ac=g.map(ab.nodes,function(ad){return ad.nodeRef});var Z=this.generateUuid();var aa=this.alfSubscribe(Z+"_SUCCESS",f.hitch(this,"onActionDeleteSuccess"),true);this.serviceXhr({alfTopic:Z,subscriptionHandle:aa,url:z.PROXY_URI+"slingshot/doclib/action/files?alf_method=delete",method:"POST",data:{nodeRefs:ac}})},onActionDeleteSuccess:function T(aa){var Z=f.getObject("requestConfig.subscriptionHandle",false,aa);if(Z!=null){this.alfUnsubscribe(Z)}this.alfPublish("ALF_DOCLIST_RELOAD_DATA",{})},onActionAssignWorkflow:function Q(aa,Z){this.callLegacyActionHandler("onActionAssignWorkflow",Z)},onActionPublish:function p(aa,Z){this.callLegacyActionHandler("onActionPublish",Z)},createTemplateContent:function d(ad){var ac=ad.params.nodeRef,Z=this._currentNode.parent.nodeRef;if(ac){var ab=z.PROXY_URI+"slingshot/doclib/node-templates",aa={parentNodeRef:Z,sourceNodeRef:ac};this.serviceXhr({url:ab,node:ac,data:aa,method:"POST",successCallback:this.templateContentCreateSuccess,failureCallback:this.templateContentCreateFailure,callbackScope:this})}},templateContentCreateSuccess:function P(aa,Z){this.displayMessage(this.message("message.create-content-by-template-node.success",aa.name));this.alfPublish("ALF_NODE_CREATED",{name:aa.name,parentNodeRef:Z.data.parentNodeRef,highlightFile:aa.name})},templateContentCreateFailure:function P(aa,Z){this.displayMessage(this.message("message.create-content-by-template-node.failure",aa.name))},onSyncLocation:function V(ab){var aa=f.clone(this._currentNode.parent);var Z={nodeRef:aa.nodeRef,displayName:aa.properties["cm:name"],jsNode:new k(aa)};this.callLegacyActionHandler("onActionCloudSync",Z)},onUnsyncLocation:function n(ab){var aa=f.clone(this._currentNode.parent);var Z={nodeRef:aa.nodeRef,displayName:aa.properties["cm:name"],jsNode:new k(aa)};this.callLegacyActionHandler("onActionCloudUnsync",Z)},onMoveDocuments:function j(ac){if(ac&&ac.sourceNodeRefs!=null){var aa=null;if(ac.targetNodeRefUri!=null){aa=z.PROXY_URI+"slingshot/doclib/action/move-to/node/"+ac.targetNodeRefUri}else{if(ac.targetPath!=null){if(this.rootNode!=null){var ab=new k(this.rootNode).nodeRef.uri;aa=z.PROXY_URI+"slingshot/doclib/action/move-to/node/"+ab+ac.targetPath}else{aa=z.PROXY_URI+"slingshot/doclib/action/move-to/site/"+this.siteId+"/"+this.containerId+"/"+ac.targetPath}}}if(aa!=null){var Z={nodeRefs:ac.sourceNodeRefs,parentId:this._currentNode.parent.nodeRef};this.serviceXhr({url:aa,data:Z,method:"POST",successCallback:this.onMoveDocumentsSuccess,failureCallback:this.onMoveDocumentsFailure,callbackScope:this})}else{this.alfLog("warn","Could not process a request to move documents due to missing attributes, either 'targetNodeRefUri' or 'targetPath' is required",ac)}}},onMoveDocumentsSuccess:function R(aa,Z){this.alfPublish(this.reloadDataTopic,{})},onMoveDocumentsFailure:function R(aa,Z){}})});