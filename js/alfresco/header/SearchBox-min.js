define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/text!./templates/SearchBox.html","dojo/text!./templates/LiveSearch.html","dojo/text!./templates/LiveSearchItem.html","alfresco/core/Core","alfresco/core/CoreXhr","alfresco/header/AlfMenuBar","service/constants/Default","dojo/json","dojo/dom-attr","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/date/stamp","dojo/on"],function(A,G,i,s,k,w,z,g,t,v,f,q,d,l,u,p,E,y,o){var x=A([s,k,t],{i18nScope:"org.alfresco.SearchBox",searchBox:null,containerNodeDocs:null,containerNodeSites:null,containerNodePeople:null,label:null,templateString:z,postMixInProperties:function r(){this.label={};i.forEach(["documents","sites","people","more"],G.hitch(this,function(H){this.label[H]=this.message("search."+H)}))},onSearchDocsMoreClick:function c(H){this.searchBox.liveSearchDocuments(this.searchBox.lastSearchText,this.searchBox.resultsCounts.docs);H.preventDefault()}});var D=A([s,k,t],{templateString:g});return A([s,k,t,v],{nonAmdDependencies:["/js/alfresco.js"],i18nScope:"org.alfresco.SearchBox",cssRequirements:[{cssFile:"./css/SearchBox.css"}],i18nRequirements:[{i18nFile:"./i18n/SearchBox.properties"}],templateString:w,_searchMenu:null,_width:"180",site:null,advancedSearch:true,allsites:false,liveSearch:true,lastSearchText:null,_keyRepeatWait:250,_minimumSearchLength:2,_resultPageSize:5,_LiveSearch:null,_requests:null,resultsCounts:null,postMixInProperties:function C(){this.label={};i.forEach(["clear"],G.hitch(this,function(H){this.label[H]=this.message("search."+H)}))},postCreate:function n(){this._requests=[];this.resultsCounts={};l.set(this._searchTextNode,"id","HEADER_SEARCHBOX_FORM_FIELD");l.set(this._searchTextNode,"placeholder",this.message("search.instruction"));o(this._searchTextNode,"keyup",G.hitch(this,function(I){this.onSearchBoxKeyUp(I)}));if(this.advancedSearch){var H=G.getObject("Alfresco.constants.SITE");this._searchMenu=new f({widgets:[{name:"alfresco/header/AlfMenuBarPopup",config:{id:this.id+"_DROPDOWN_MENU",showArrow:false,label:"",iconSrc:"js/alfresco/header/css/images/search-16-gray.png",iconClass:"alf-search-icon",widgets:[{name:"alfresco/menus/AlfMenuItem",config:{id:this.id+"_ADVANCED_SEARCH",i18nScope:"org.alfresco.SearchBox",label:"search.advanced",targetUrl:(H?"site/"+H+"/":"")+"advsearch"}}]}}]});this._searchMenu.placeAt(this._searchMenuNode);this._searchMenu.startup()}if(this.liveSearch){this._LiveSearch=new x({searchBox:this});this._LiveSearch.placeAt(this._searchLiveNode);o(window,"click",G.hitch(this,function(I){u.set(this._LiveSearch.containerNode,"display","none")}));o(this._searchTextNode,"click",G.hitch(this,function(I){if(this.resultsCounts.docs>0||this.resultsCounts.sites>0||this.resultsCounts.people>0){u.set(this._LiveSearch.containerNode,"display","block")}I.stopPropagation()}));o(this._LiveSearch,"click",function(I){I.stopPropagation()})}this.addAccessibilityLabel()},linkToFacetedSearch:true,generateSearchPageLink:function b(I){var H;if(this.linkToFacetedSearch===true){H="dp/ws/faceted-search#searchTerm="+encodeURIComponent(I)+(this.allsites?"&allSites=true&repo=false":"&allSites=false&repo=true")+"&sortField=Relevance";if(this.site!=null){H="site/"+this.site+"/"+H}}else{H="search?t="+encodeURIComponent(I)+(this.allsites?"&a=true&r=false":"&a=false&r=true");if(this.site!=null){H="site/"+this.site+"/"+H}}this.alfLog("log","Generated search page link",H,this);return H},onSearchBoxKeyUp:function m(H){var K=G.trim(this._searchTextNode.value);switch(H.keyCode){case 13:if(K.length>0){this.clearResults();this.alfLog("log","Search request for: ",K);var I=this.generateSearchPageLink(K);this.alfPublish("ALF_NAVIGATE_TO_PAGE",{url:I,type:"SHARE_PAGE_RELATIVE",target:"CURRENT"})}break;default:if(this.liveSearch){if(K.length>=this._minimumSearchLength&&K!==this.lastSearchText){u.set(this._LiveSearch.containerNode,"display","block");this.lastSearchText=K;for(var J=0;J<this._requests.length;J++){this._requests[J].cancel()}this._requests=[];var L=Date.now();if(this._timeoutHandle){clearTimeout(this._timeoutHandle)}var M=this;this._timeoutHandle=setTimeout(function(){M.liveSearchDocuments(K,0);M.liveSearchSites(K,0);M.liveSearchPeople(K,0)},this._keyRepeatWait)}}if(K.length===0){this.clearResults()}}},liveSearchDocuments:function j(H,I){var J=this;this._documentsWaitTimeout=setTimeout(function(){p.add(J._LiveSearch.titleNodeDocs,"wait")},2000);this._requests.push(this.serviceXhr({url:q.PROXY_URI+"slingshot/live-search-docs?t="+encodeURIComponent(H)+"&maxResults="+this._resultPageSize+"&startIndex="+I,method:"GET",successCallback:function(K){clearTimeout(this._documentsWaitTimeout);p.remove(this._LiveSearch.titleNodeDocs,"wait");if(I===0){this._LiveSearch.containerNodeDocs.innerHTML=""}i.forEach(K.items,function(M){var L=(M.site?"site/"+M.site.shortName+"/":"");var N="";if(M.site){N+="<a href='"+q.URL_PAGECONTEXT+L+"documentlibrary'>"+this.encodeHTML(M.site.title)+"</a> | "}N+="<a href='"+q.URL_PAGECONTEXT+"user/"+this.encodeHTML(M.modifiedBy)+"/profile'>"+this.encodeHTML(M.modifiedBy)+"</a> | ";N+=Alfresco.util.relativeTime(M.modifiedOn)+" | ";N+=Alfresco.util.formatFileSize(M.size);var O=this.encodeHTML(M.title);if(M.description){O+=(O.length!==0?"\r\n":"")+this.encodeHTML(M.description)}var P=new D({cssClass:"alf-livesearch-thumbnail",title:O,label:this.encodeHTML(M.name),link:q.URL_PAGECONTEXT+L+"document-details?nodeRef="+M.nodeRef,icon:q.PROXY_URI+"api/node/"+M.nodeRef.replace(":/","")+"/content/thumbnails/doclib?c=queue&ph=true&lastModified="+(M.lastThumbnailModification||1),alt:this.encodeHTML(M.name),meta:N});P.placeAt(this._LiveSearch.containerNodeDocs)},this);u.set(this._LiveSearch.nodeDocsMore,"display",K.hasMoreRecords?"block":"none");if(I===0){this.resultsCounts.docs=0}this.resultsCounts.docs+=K.items.length},failureCallback:function(K){clearTimeout(this._documentsWaitTimeout);p.remove(this._LiveSearch.titleNodeDocs,"wait");u.set(this._LiveSearch.nodeDocsMore,"display","none");if(I===0){this._LiveSearch.containerNodeDocs.innerHTML="";this.resultsCounts.docs=0}},callbackScope:this}))},liveSearchSites:function F(H,I){var J=this;this._sitesWaitTimeout=setTimeout(function(){p.add(J._LiveSearch.titleNodeSites,"wait")},2000);this._requests.push(this.serviceXhr({url:q.PROXY_URI+"slingshot/live-search-sites?t="+encodeURIComponent(H)+"&maxResults="+this._resultPageSize,method:"GET",successCallback:function(K){clearTimeout(this._sitesWaitTimeout);p.remove(this._LiveSearch.titleNodeSites,"wait");this._LiveSearch.containerNodeSites.innerHTML="";i.forEach(K.items,function(L){var M=new D({cssClass:"alf-livesearch-icon",title:this.encodeHTML(L.description),label:this.encodeHTML(L.title),link:q.URL_PAGECONTEXT+"site/"+L.shortName+"/dashboard",icon:q.URL_RESCONTEXT+"components/images/filetypes/generic-site-32.png",alt:this.encodeHTML(L.title),meta:L.description?this.encodeHTML(L.description):"&nbsp;"});M.placeAt(this._LiveSearch.containerNodeSites)},this);this.resultsCounts.sites=K.items.length},failureCallback:function(K){clearTimeout(this._sitesWaitTimeout);p.remove(this._LiveSearch.titleNodeSites,"wait");this._LiveSearch.containerNodeSites.innerHTML="";this.resultsCounts.sites=0},callbackScope:this}))},liveSearchPeople:function B(H,I){var J=this;this._peopleWaitTimeout=setTimeout(function(){p.add(J._LiveSearch.titleNodePeople,"wait")},2000);this._requests.push(this.serviceXhr({url:q.PROXY_URI+"slingshot/live-search-people?t="+encodeURIComponent(H)+"&maxResults="+this._resultPageSize,method:"GET",successCallback:function(K){clearTimeout(this._peopleWaitTimeout);p.remove(this._LiveSearch.titleNodePeople,"wait");this._LiveSearch.containerNodePeople.innerHTML="";i.forEach(K.items,function(L){var N=L.firstName+" "+L.lastName;var M=this.encodeHTML(L.jobtitle||"")+(L.location?(", "+this.encodeHTML(L.location)):"");var O=new D({cssClass:"alf-livesearch-icon",title:this.encodeHTML(L.jobtitle||""),label:this.encodeHTML(N+" ("+L.userName+")"),link:q.URL_PAGECONTEXT+"user/"+encodeURIComponent(L.userName)+"/profile",icon:q.PROXY_URI+"slingshot/profile/avatar/"+encodeURIComponent(L.userName)+"/thumbnail/avatar32",alt:this.encodeHTML(N),meta:M?M:"&nbsp;"});O.placeAt(this._LiveSearch.containerNodePeople)},this);this.resultsCounts.people=K.items.length},failureCallback:function(K){clearTimeout(this._peopleWaitTimeout);p.remove(this._LiveSearch.titleNodePeople,"wait");this._LiveSearch.containerNodePeople.innerHTML="";this.resultsCounts.people=0},callbackScope:this}))},clearResults:function h(){this._searchTextNode.value="";if(this.liveSearch){this.lastSearchText="";for(var H=0;H<this._requests.length;H++){this._requests[H].cancel()}this._requests=[];this.resultsCounts={};this._LiveSearch.containerNodeDocs.innerHTML="";this._LiveSearch.containerNodePeople.innerHTML="";this._LiveSearch.containerNodeSites.innerHTML="";p.remove(this._LiveSearch.titleNodeDocs,"wait");p.remove(this._LiveSearch.titleNodePeople,"wait");p.remove(this._LiveSearch.titleNodeSites,"wait");u.set(this._LiveSearch.nodeDocsMore,"display","none");u.set(this._LiveSearch.containerNode,"display","none")}this._searchTextNode.focus()},addAccessibilityLabel:function e(){E.create("label",{"for":"HEADER_SEARCHBOX_FORM_FIELD",innerHTML:this.message("search.label"),"class":"hidden"},this._searchTextNode,"before")},onSearchClearClick:function a(H){this.clearResults();H.preventDefault()}})});