define(["dojo/_base/declare","alfresco/renderers/Toggle","alfresco/services/_QuickShareServiceTopicMixin","alfresco/core/CoreWidgetProcessing","dojo/text!./templates/QuickShare.html","dojo/_base/lang","dojo/_base/array","dojo/dom-class","dijit/registry","alfresco/menus/AlfMenuBar","alfresco/menus/AlfMenuBarPopup","alfresco/menus/AlfCascadingMenu","alfresco/menus/AlfMenuGroup","alfresco/menus/AlfMenuItem","alfresco/menus/AlfMenuTextForClipboard"],function(t,o,f,p,x,y,g,k,h,d,b,w,c,r,v){return t([o,f,p],{i18nRequirements:[{i18nFile:"./i18n/QuickShare.properties"}],cssRequirements:[{cssFile:"./css/QuickShare.css"}],templateString:x,onLabel:"quick-share.enabled.label",offLabel:"quick-share.disabled.label",onTooltip:"quick-share.enabled.description",offTooltip:"quick-share.disabled.description",toggleClass:"quick-share",postMixInProperties:function u(){this.toggleOnTopic=(this.toggleOnTopic!=null)?this.toggleOnTopic:this.addQuickShareTopic;this.toggleOnSuccessTopic=(this.toggleOnSuccessTopic!=null)?this.toggleOnSuccessTopic:this.addQuickShareSuccessTopic;this.toggleOnFailureTopic=(this.toggleOnFailureTopic!=null)?this.toggleOnFailureTopic:this.addQuickShareFailureTopic;this.toggleOffTopic=(this.toggleOffTopic!=null)?this.toggleOffTopic:this.removeQuickShareTopic;this.toggleOffSuccessTopic=(this.toggleOffSuccessTopic!=null)?this.toggleOffSuccessTopic:this.removeQuickShareSuccessTopic;this.toggleOffFailureTopic=(this.toggleOffFailureTopic!=null)?this.toggleOffFailureTopic:this.removeQuickShareFailureTopic;this.alfSubscribe(this.toggleOffTopic,y.hitch(this,"renderToggledOff"));this.inherited(arguments)},getInitialState:function i(){return typeof this.currentItem.jsNode.properties["qshare:sharedId"]!="undefined"},postCreate:function l(){this.inherited(arguments);if(this.currentItem.node!=null&&this.currentItem.node.isContainer){k.add(this.domNode,"hidden")}else{this.alfPublish(this.getQuickShareLinkTopic,{callback:this.setQuickShareLink,callbackScope:this});this.alfPublish(this.getSocialLinksTopic,{callback:this.setSocialLinks,callbackScope:this});if(this.isToggleOn){this.widgets=this.defineWidgets(this.currentItem.jsNode.properties["qshare:sharedId"]);this.processWidgets(this.widgets,this.onNode)}}},setQuickShareLink:function j(z){this.quickShareLink=z},setSocialLinks:function s(z){this.socialLinks=z},onToggleOnSuccess:function a(z){this.inherited(arguments);this.widgets=this.defineWidgets(z.response.sharedId);this.processWidgets(this.widgets,this.onNode)},onToggleOffSuccess:function n(A){this.inherited(arguments);if(this.onNode.children!=null&&this.onNode.children.length>0){var z=h.byNode(this.onNode.children[0]);z.destroy()}},defineWidgets:function q(A){var B="http://"+window.location.host+this.quickShareLink.replace("{sharedId}",A);var z=[{name:"alfresco/menus/AlfMenuBar",config:{widgets:[{name:"alfresco/menus/AlfMenuBarPopup",config:{label:this.message("quick-share.enabled.label"),iconClass:"alf-quick-share-enabled-icon",widgets:[{name:"alfresco/menus/AlfMenuGroup",config:{widgets:[{name:"alfresco/menus/AlfCascadingMenu",config:{label:this.message("quick-share.public-url.label"),widgets:[{name:"alfresco/menus/AlfMenuGroup",config:{widgets:[{name:"alfresco/menus/AlfMenuTextForClipboard",config:{textForClipboard:B}}]}}]}},{name:"alfresco/menus/AlfMenuItem",config:{label:this.message("quick-share.view.label"),publishTopic:"ALF_NAVIGATE_TO_PAGE",publishPayload:{url:B,type:"FULL_PATH",target:"NEW"}}},{name:"alfresco/menus/AlfMenuItem",config:{label:this.message("quick-share.unshare.label"),publishTopic:this.toggleOffTopic,publishPayload:{node:this.currentItem,sharedId:A}}},{name:"alfresco/menus/AlfCascadingMenu",config:{label:this.message("quick-share.share-with.label"),widgets:[{name:"alfresco/menus/AlfMenuGroup",config:{widgets:this.defineSocialLinkWidgets(B)}}]}}]}}]}}]}}];return z},defineSocialLinkWidgets:function m(A){var z=[];if(this.socialLinks!=null){g.forEach(this.socialLinks,y.hitch(this,"defineSocialLinkWidget",z,A))}return z},defineSocialLinkWidget:function e(D,F,A,B){if(A.id!=null&&A.params!=null){var z=null;for(var C=0;C<A.params.length;C++){if(typeof A.params[C].href!="undefined"){z=A.params[C].href}}if(z!=null){var G=y.replace(z,y.hitch(this,"substituteSocialConfigTokens",A.id,F));var E={name:"alfresco/menus/AlfMenuItem",config:{label:this.message("linkshare.action."+A.id+".label"),iconClass:"alf-social-"+A.id+"-icon",publishTopic:"ALF_NAVIGATE_TO_PAGE",publishPayload:{url:G,type:"FULL_PATH",target:"NEW"}}};D.push(E)}else{this.alfLog("warn","A social publishing link was configured that didn't include an 'href' parameter",A)}}else{this.alfLog("warn","A social publishing link was configured that didn't include an 'id' attribute",A)}},substituteSocialConfigTokens:function(D,B,z,A){if(A=="shareUrl"){return B}else{if(A=="displayName"){return this.currentItem.displayName}else{var C=this.message("linkshare.action."+D+"."+A,{"0":B,"1":this.currentItem.displayName});return C}}}})});