define(["dojo/_base/declare","alfresco/renderers/InlineEditProperty","dijit/_OnDijitClickMixin","alfresco/core/ObjectTypeUtils","alfresco/core/CoreXhr","dojo/text!./templates/Tags.html","dojo/_base/array","dojo/_base/lang","alfresco/renderers/ReadOnlyTag","alfresco/renderers/EditTag","dojo/dom-construct","dijit/registry","dojo/on","dojo/dom-attr","dojo/dom-class","dojo/keys","dojo/_base/event","dojo/store/JsonRest","dijit/form/ComboBox","dijit/form/nls/ComboBox","dijit/form/nls/validate","dojo/store/util/QueryResults","dojo/store/util/SimpleQueryEngine","dojo/data/util/filter","dojo/aspect","dojo/html","service/constants/Default"],function(d,o,I,m,x,g,h,f,E,k,N,R,J,Q,v,D,T,B,s,P,t,c,u,K,p,F,z){return d([o,I,x],{cssRequirements:[{cssFile:"./css/Tags.css"}],templateString:g,postMixInProperties:function O(){this.inherited(arguments)},currentReadOnlyTags:null,getRenderedProperty:function a(W){var V=null;h.forEach(this.currentTags,f.hitch(this,"destroyTag"));this.currentTags=[];if(!m.isArray(W)){this.alfLog("warn","Expected an array value for tags",this,W)}else{h.forEach(W,f.hitch(this,"createReadOnlyTag","name","nodeRef"));V=""}return V},destroyTag:function M(V){if(typeof V.destroy==="function"){V.destroy()}},createReadOnlyTag:function S(Y,V,Z,W){if(Z==null||Z[Y]==null){this.alfLog("warn","No '"+Y+"' attribute for tag",this,tag)}else{var X=new E({tagName:Z[Y],tagValue:Z[V]});this.currentTags.push(X)}},postCreate:function C(){this.inherited(arguments);J(this.editTagsNode,"ALF_REMOVE_TAG",f.hitch(this,"onRemoveTag"));h.forEach(this.currentTags,f.hitch(this,"placeReadOnlyTag"))},placeReadOnlyTag:function y(W,V){W.placeAt(this.renderedValueNode)},onEditClick:function n(){this.inherited(arguments);h.forEach(this.currentTags,f.hitch(this,"createEditTag","tagName","tagValue"));if(this.tagStore==null){this.tagStore=new B({target:z.PROXY_URI+"api/forms/picker/category/workspace/SpacesStore/tag:tag-root/children"});p.before(this.tagStore,"query",f.hitch(this,"interceptQuery"))}if(this.comboBox==null){this.comboBox=new s({store:this.tagStore,searchAttr:"name",queryExpr:"${0}"},this.editInputNode);p.before(this.comboBox,"_openResultList",f.hitch(this,"interceptResults"))}},interceptQuery:function b(X,W){var V={selectableType:"cm:category",size:"100",aspect:"cm:taggable",searchTerm:X.name};return[X,W]},interceptResults:function U(Z,aa,X){var W=Z.data.items;var V={name:new RegExp("^"+aa.name.toString()+".*$")};var Y=c(u(V)(W));return[Y,V,X]},createEditTag:function G(Y,V,Z,W){var X=new k({tagName:Z[Y],tagValue:Z[V]});X.placeAt(this.editTagsNode)},onRemoveTag:function H(V){var W=R.byNode(V.target);if(W!=null){W.destroy()}},onPropertyUpdate:function q(W,X){F.set(this.renderedValueNode,"");h.forEach(this.currentTags,f.hitch(this,"destroyTag"));this.currentTags=[];var V=R.findWidgets(this.editTagsNode);h.forEach(V,f.hitch(this,"createReadOnlyTag","tagName","tagValue"));h.forEach(this.currentTags,f.hitch(this,"placeReadOnlyTag"));h.forEach(V,f.hitch(this,"destroyTag"));v.remove(this.renderedValueNode,"hidden faded");v.add(this.editNode,"hidden");this.renderedValueNode.focus()},onValueEntryKeyPress:function w(W){if(W.charOrCode==D.ESCAPE){T.stop(W);this.onCancel()}else{if(W.charOrCode==D.ENTER){T.stop(W);var V=this.comboBox.get("value");if(V!=""){this.comboBox.set("value","");this.createRemoteTag(V,false)}else{this.onSave()}}else{if(W.charOrCode==D.PAGE_DOWN||W.charOrCode==D.DOWN_ARROW||W.charOrCode==D.PAGE_UP||W.charOrCode==D.UP_ARROW){T.stop(W)}}}},getCreateRemoteTagURL:function i(){return z.PROXY_URI+"api/tag/workspace/SpacesStore"},getCreateRemoteTagData:function e(V){return{name:V}},createRemoteTag:function i(W,X){var V={url:this.getCreateRemoteTagURL(),method:"POST",saveTagsAfterCreate:X,data:this.getCreateRemoteTagData(W),successCallback:this.onCreateRemoteTagSuccess,failureCallback:this.onCreateRemoteTagFailure,callbackScope:this};this.serviceXhr(V)},onCreateRemoteTagSuccess:function j(W,V){this.createEditTag("name","nodeRef",W);if(V.saveTagsAfterCreate==true){this.onSave()}},onCreateRemoteTagFailure:function A(W,V){this.alfLog("error","Could not create a tag",W,V)},onSave:function L(){var V=this.comboBox.get("value");if(V!=""){this.comboBox.set("value","");this.createRemoteTag(V,true)}else{this.inherited(arguments)}},onCancel:function l(){this.inherited(arguments);this.comboBox.set("value","");var V=R.findWidgets(this.editTagsNode);h.forEach(V,f.hitch(this,"destroyTag"))},getSaveData:function r(){var W=R.findWidgets(this.editTagsNode);var V="";for(var X=0;X<W.length;X++){V=V+","+W[X].tagValue}if(V.length>0){V=V.substring(1)}var Y={};Y[this.postParam]=V;return Y}})});