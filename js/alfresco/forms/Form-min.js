define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/form/Form","dojo/_base/xhr","alfresco/core/Core","alfresco/core/CoreWidgetProcessing","alfresco/documentlibrary/_AlfHashMixin","dojo/text!./templates/Form.html","dojo/io-query","dojo/_base/lang","alfresco/buttons/AlfButton","dojo/_base/array","dojo/json","dijit/registry","dojo/hash"],function(v,n,j,f,i,o,r,m,y,u,A,p,g,t,h,a){return v([n,j,o,r,m],{i18nRequirements:[{i18nFile:"./i18n/Form.properties"}],templateString:y,_form:null,widgets:null,postUrl:"",convertFormToJsonString:false,invalidFormControls:null,okButton:null,cancelButton:null,scopeFormControls:true,displayButtons:true,postCreate:function q(){this.invalidFormControls=[];if(this.scopeFormControls==true&&this.pubSubScope==""){this.pubSubScope=this.generateUuid()}this._form=new f({id:this.generateUuid()},this.formNode);this.alfSubscribe("ALF_INVALID_CONTROL",A.hitch(this,"onInvalidField"));this.alfSubscribe("ALF_VALID_CONTROL",A.hitch(this,"onValidField"));if(this.displayButtons==true){this.createButtons()}if(this.widgets){this.processWidgets(this.widgets,this._form.domNode)}},onInvalidField:function l(C){var B=g.some(this.invalidFormControls,function(D){return D==C.fieldId});if(!B){this.invalidFormControls.push(C.fieldId)}if(this.okButton){this.okButton.set("disabled","true")}},onValidField:function z(C){this.invalidFormControls=g.filter(this.invalidFormControls,function(D){return D!=C.fieldId});if(this.okButton){this.okButton.set("disabled",this.invalidFormControls.length>0)}var B=this.getValue();g.forEach(this.additionalButtons,function(E,D){if(E.publishPayload!=null){A.mixin(E.publishPayload,B)}else{E.publishPayload=B}})},showOkButton:true,showCancelButton:true,okButtonLabel:"form.button.ok.label",okButtonPublishTopic:null,okButtonPublishPayload:null,okButtonPublishGlobal:null,cancelButtonLabel:"form.button.cancel.label",cancelButtonPublishTopic:null,cancelButtonPublishPayload:null,cancelButtonPublishGlobal:null,widgetsAdditionalButtons:null,additionalButtons:null,useHash:false,setHash:false,setHashFragment:function d(C){delete C.alfTopic;var B=u.objectToQuery(C);this.alfPublish("ALF_NAVIGATE_TO_PAGE",{url:B,type:"HASH"},true)},onHashChange:function c(C){if(this.useHash==true){var B=this.processFilter(C);this.setValue(B)}},createButtons:function s(){if(this.showOkButton==true){this.okButton=new p({pubSubScope:this.pubSubScope,label:this.message(this.okButtonLabel),additionalCssClasses:"confirmationButton "+((this.okButtonClass!=null)?this.okButtonClass:""),publishTopic:this.okButtonPublishTopic,publishPayload:this.okButtonPublishPayload,publishGlobal:this.okButtonPublishGlobal,iconClass:this.okButtonIconClass},this.okButtonNode);if(this.setHash==true){if(this.okButtonPublishTopic!=null&&this.okButtonPublishTopic.trim()!=null){this.alfSubscribe(this.okButtonPublishTopic,A.hitch(this,"setHashFragment"),this.okButtonPublishGlobal)}else{this.alfLog("warn","A form is configured to use the browser hash fragment, but has no okButtonPublishTopic set",this)}}}if(this.showCancelButton==true){this.cancelButton=new p({pubSubScope:this.pubSubScope,label:this.message(this.cancelButtonLabel),additionalCssClasses:"cancelButton",publishTopic:this.cancelButtonPublishTopic,publishPayload:this.cancelButtonPublishPayload,publishGlobal:this.cancelButtonPublishGlobal,iconClass:this.cancelButtonIconClass},this.cancelButtonNode)}if(this.widgetsAdditionalButtons!=null){this.additionalButtons=[];this.__creatingButtons=true;this.processWidgets(this.widgetsAdditionalButtons,this.buttonsNode)}else{this.additionalButtons=h.findWidgets(this.buttonsNode)}},allWidgetsProcessed:function e(C){if(this.__creatingButtons===true){this.additionalButtons=h.findWidgets(this.buttonsNode);this.__creatingButtons=false}else{if(this.useHash){var B=u.queryToObject(a());this.setValue(B)}g.forEach(C,function(E,D){if(E.publishValue&&typeof E.publishValue=="function"){E.publishValue()}})}this.validate()},updateButtonPayloads:function b(B){g.forEach(this.additionalButtons,function(D,C){if(D.payload==null){D.payload={}}A.mixin(D.payload,B)})},getValue:function x(){var B={};if(this._form){g.forEach(this._form.getChildren(),function(D,C){if(((D._visible!==undefined&&D._visible==false)||(D._disabled!==undefined&&D._disabled==true))&&(D.postWhenHiddenOrDisabled!==undefined&&D.postWhenHiddenOrDisabled==false)){}else{A.setObject(D.get("name"),D.getValue(),B)}})}this.alfLog("log","Returning form values: ",B);this.updateButtonPayloads(B);return B},setValue:function k(B){this.alfLog("log","Setting form values: ",B);if(B&&B instanceof Object){if(this._form){g.forEach(this._form.getChildren(),function(D,C){if(((D._visible!==undefined&&D._visible==false)||(D._disabled!==undefined&&D._disabled==true))&&(D.noValueUpdateWhenHiddenOrDisabled!==undefined&&D.noValueUpdateWhenHiddenOrDisabled==true)){}else{D.setValue(A.getObject(D.get("name"),false,B))}})}}this.validate();this.updateButtonPayloads(B)},validate:function w(){this.alfLog("log","Validating form",this._form);g.forEach(this._processedWidgets,function(C,B){if(C.publishValue&&typeof C.publishValue=="function"){C.validate()}});return this.invalidFormControls.length==0}})});