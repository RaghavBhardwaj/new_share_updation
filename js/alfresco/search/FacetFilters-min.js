define(["dojo/_base/declare","alfresco/documentlibrary/AlfDocumentFilters","alfresco/search/FacetFilter","dojo/_base/lang","dojo/_base/array","dojo/dom-construct","dojo/dom-class","dojo/on","dijit/registry"],function(j,b,k,c,l,f,n,m,a){return j([b],{filterPrefsName:"docListFilterPref",facetQName:null,maxFilters:null,hitThreshold:null,minFilterValueLength:null,sortBy:"ALPHABETICALLY",useHash:false,postCreate:function h(){if(this.label!=null&&this.label!=""){Alfresco.util.createTwister(this.labelNode,this.filterPrefsName)}this.alfSubscribe("ALF_WIDGETS_READY",c.hitch(this,"publishFacets"),true)},blockIncludeFacetRequest:false,publishFacets:function p(){if(this.facetQName!=null&&this.facetQName!=""){if(this.blockIncludeFacetRequest==false){this.alfPublish("ALF_INCLUDE_FACET",{qname:this.facetQName},true)}this.alfSubscribe("ALF_FACET_RESULTS_@"+this.facetQName,c.hitch(this,"processFacetFilters"))}else{this.alfLog("warn","No facet QNname was provided for a filter",this)}},processFacetFilters:function q(v){this.alfLog("log","Facet Results received!",v,this);this.moreFiltersList=null;n.add(this.showMoreNode,"hidden");n.add(this.showLessNode,"hidden");var t=a.findWidgets(this.filtersNode);l.forEach(t,function(z,y){z.destroy()});var x=[];if(v.activeFilters!=null){x=v.activeFilters.split(",")}var u=[];for(var s in v.facetResults){var w=v.facetResults[s];u.push({label:w.label,value:w.value,hits:w.hits,index:w.index})}u=this.sortFacetFilters(u);var r=this.maxFilters;l.forEach(u,function(A,z){if(this.minFilterValueLength!=null&&A.value.length<this.minFilterValueLength){}else{if(this.hitThreshold==null||this.hitThreshold<=A.hits){var B=l.some(x,function(D,C){return D==this.facetQName.replace(/\.__.u/g,"").replace(/\.__/g,"")+"|"+A.value},this);var y=new k({label:A.label,hits:A.hits,filter:A.value,facet:this.facetQName,applied:B,useHash:this.useHash,pubSubScope:this.pubSubScope});if(r!=null&&r<=0&&!B){this.addMoreFilter(y)}y.placeAt(this.showMoreNode,"before");if(r!=null){r--}}}},this);if(this.moreFiltersList!=null){n.remove(this.showMoreNode,"hidden")}if(u.length==0){n.add(this.domNode,"hidden")}else{n.remove(this.domNode,"hidden")}},sortFacetFilters:function g(r){if(this.sortBy==null||this.sortBy.trim()==="ALPHABETICALLY"){return r.sort(this._alphaSort)}else{if(this.sortBy.trim()==="ASCENDING"){return r.sort(this._ascSort)}else{if(this.sortBy.trim()==="DESCENDING"){return r.sort(this._descSort)}else{if(this.sortBy.trim()==="INDEX"){return r.sort(this._indexSort)}else{return r}}}}},_alphaSort:function d(s,r){var t=s.label.toLowerCase();var u=r.label.toLowerCase();if(t<u){return -1}if(t>u){return 1}return 0},_ascSort:function i(s,r){return s.hits-r.hits},_descSort:function o(s,r){return r.hits-s.hits},_indexSort:function e(s,r){return s.index-r.index}})});